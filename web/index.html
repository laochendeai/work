<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bidding Intelligence</title>
    <link rel="stylesheet" href="style.css?v=5">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Force compact styles for export modal */
        #export-modal .modal-content {
            max-width: 480px !important;
        }

        #export-modal .modal-body {
            padding: 1rem 1.5rem !important;
        }

        #export-modal .export-section {
            margin-bottom: 0.8rem !important;
        }

        #export-modal .filter-box {
            padding: 0.75rem !important;
        }

        #export-modal .filter-grid {
            gap: 0.5rem !important;
        }

        #export-modal .filter-item input,
        #export-modal .filter-item select {
            padding: 0.4rem !important;
            font-size: 0.85rem !important;
        }

        #export-modal .format-selection-grid {
            gap: 8px !important;
            margin-bottom: 5px !important;
        }

        #export-modal .format-option {
            padding: 0.6rem !important;
            gap: 4px !important;
        }

        #export-modal .format-option i {
            font-size: 1.2rem !important;
        }

        #export-modal .export-options-row {
            padding: 0.5rem 0.8rem !important;
        }

        #export-modal h2 {
            padding: 1rem 1.5rem !important;
            font-size: 1.1rem !important;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <i class="fa-solid fa-layer-group"></i>
                <span>BiddingIntel</span>
            </div>

            <ul class="nav-links">
                <li class="active" data-tab="dashboard">
                    <i class="fa-solid fa-chart-pie"></i>
                    <span>数据概览</span>
                </li>
                <li data-tab="search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <span>搜索任务</span>
                </li>
                <li data-tab="results">
                    <i class="fa-solid fa-list"></i>
                    <span>公告列表</span>
                </li>
                <li data-tab="cards">
                    <i class="fa-solid fa-address-card"></i>
                    <span>名片库</span>
                </li>
            </ul>

            <div class="status-indicator" id="server-status">
                <div class="dot"></div>
                <span>系统就绪</span>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">

            <!-- DASHBOARD VIEW -->
            <section id="dashboard" class="view active">
                <header class="view-header">
                    <h1>数据概览</h1>
                    <p class="subtitle">系统统计与近期活动</p>
                </header>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon-box"><i class="fa-solid fa-file-contract"></i></div>
                        <div class="stat-info">
                            <h3>公告总数</h3>
                            <p id="stat-total-announcements">--</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon-box"><i class="fa-solid fa-address-book"></i></div>
                        <div class="stat-info">
                            <h3>已收录名片</h3>
                            <p id="stat-total-cards">--</p>
                        </div>
                    </div>
                </div>

                <div class="content-block">
                    <h2>热门公司 (Top 5)</h2>
                    <ul class="top-list" id="top-companies-list">
                        <!-- Populated by JS -->
                        <li>加载中...</li>
                    </ul>
                </div>
            </section>

            <!-- SEARCH VIEW -->
            <section id="search" class="view">
                <header class="view-header">
                    <h1>新建搜索</h1>
                    <p class="subtitle">根据关键词抓取最新中标信息</p>
                </header>

                <div class="split-layout">
                    <!-- Form -->
                    <div class="form-container">
                        <div class="input-group">
                            <label>搜索关键词 (多个关键词请用逗号/空格分隔)</label>
                            <input type="text" id="search-kw" placeholder="如：机房, 弱电, 智能化" value="机房">
                            <div class="keyword-file-row">
                                <input type="file" id="keyword-file-input" accept=".txt,.csv" style="display:none;">
                                <button type="button" class="btn small secondary" id="btn-upload-keywords">
                                    <i class="fa-solid fa-upload"></i> 上传关键词文件
                                </button>
                                <span id="keyword-file-name" class="file-name-hint"></span>
                            </div>
                            <div class="keyword-hint">支持 .txt/.csv 文件，每行一个关键词或逗号分隔</div>
                        </div>

                        <div class="row">
                            <div class="input-group">
                                <label>时间范围</label>
                                <select id="search-time" onchange="toggleCustomDate()">
                                    <option value="today">今天</option>
                                    <option value="3days">近3天</option>
                                    <option value="1week" selected>近1周</option>
                                    <option value="1month">近1月</option>
                                    <option value="3months">近3月</option>
                                    <option value="halfyear">近半年</option>
                                    <option value="custom">自定义范围</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>最大抓取页数</label>
                                <input type="number" id="search-pages" value="3" min="1" max="20">
                            </div>
                        </div>

                        <!-- Custom Date Range (Hidden by default) -->
                        <div class="row" id="custom-date-row" style="display: none;">
                            <div class="input-group">
                                <label>开始日期</label>
                                <input type="date" id="search-start-date">
                            </div>
                            <div class="input-group">
                                <label>结束日期</label>
                                <input type="date" id="search-end-date">
                            </div>
                        </div>

                        <!-- Advanced Options Collapsible -->
                        <details open>
                            <summary>高级筛选项</summary>
                            <div class="row">
                                <div class="input-group">
                                    <label>搜索模式</label>
                                    <select id="search-type">
                                        <option value="fulltext" selected>全文搜索</option>
                                        <option value="title">仅搜标题</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>品目 (Pinmu)</label>
                                    <select id="search-pinmu">
                                        <option value="all" selected>全部</option>
                                        <option value="goods">货物类</option>
                                        <option value="engineering">工程类</option>
                                        <option value="services">服务类</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="input-group">
                                    <label>来源类别 (BidSort)</label>
                                    <select id="search-category">
                                        <option value="all" selected>全部</option>
                                        <option value="central">中央</option>
                                        <option value="local">地方</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>公告类型 (BidType)</label>
                                    <select id="search-bid-type">
                                        <option value="all" selected>全部</option>
                                        <option value="1">公开招标</option>
                                        <option value="7">中标公告</option>
                                        <option value="2">竞争性谈判</option>
                                        <option value="3">竞争性磋商</option>
                                        <option value="4">询价公告</option>
                                        <option value="5">单一来源</option>
                                    </select>
                                </div>
                            </div>
                        </details>

                        <div class="actions">
                            <button id="btn-start" class="btn primary">
                                <i class="fa-solid fa-play"></i> 开始搜索
                            </button>
                            <button id="btn-stop" class="btn danger" disabled>
                                <i class="fa-solid fa-stop"></i> 停止
                            </button>
                        </div>
                    </div>

                    <!-- Terminal/Logs -->
                    <div class="terminal-window">
                        <div class="terminal-header">
                            <span><i class="fa-solid fa-terminal"></i> 运行日志</span>
                            <button id="btn-clear-log" class="icon-btn" title="清空日志"><i
                                    class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="terminal-body" id="log-output">
                            <div class="log-line system">准备就绪...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- RESULTS VIEW -->
            <section id="results" class="view">
                <header class="view-header">
                    <div class="header-left">
                        <h1>公告列表</h1>
                        <div class="search-bar">
                            <input type="text" id="announcement-search-input" placeholder="搜索关键词...">
                            <select id="province-filter">
                                <option value="">全部省份</option>
                                <option value="北京">北京</option>
                                <option value="上海">上海</option>
                                <option value="广东">广东</option>
                                <option value="江苏">江苏</option>
                                <option value="浙江">浙江</option>
                                <option value="山东">山东</option>
                                <option value="河南">河南</option>
                                <option value="四川">四川</option>
                                <option value="湖北">湖北</option>
                                <option value="湖南">湖南</option>
                                <option value="福建">福建</option>
                                <option value="安徽">安徽</option>
                                <option value="河北">河北</option>
                                <option value="陕西">陕西</option>
                                <option value="江西">江西</option>
                                <option value="重庆">重庆</option>
                                <option value="辽宁">辽宁</option>
                                <option value="云南">云南</option>
                                <option value="广西">广西</option>
                                <option value="山西">山西</option>
                                <option value="贵州">贵州</option>
                                <option value="天津">天津</option>
                                <option value="新疆">新疆</option>
                                <option value="内蒙古">内蒙古</option>
                                <option value="黑龙江">黑龙江</option>
                                <option value="吉林">吉林</option>
                                <option value="甘肃">甘肃</option>
                                <option value="海南">海南</option>
                                <option value="宁夏">宁夏</option>
                                <option value="青海">青海</option>
                                <option value="西藏">西藏</option>
                            </select>
                            <button class="btn small" onclick="loadAnnouncements(true)">筛选</button>
                        </div>
                    </div>
                    <div class="header-actions">
                        <span id="announcements-count-info" class="count-info">加载中...</span>
                        <button class="btn primary small" id="btn-export-announcements">
                            <i class="fa-solid fa-download"></i> 导出
                        </button>
                        <button class="btn small" onclick="loadAnnouncements(true)">
                            <i class="fa-solid fa-refresh"></i> 刷新
                        </button>
                    </div>
                </header>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>发布时间</th>
                                <th>标题</th>
                                <th>来源</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="announcements-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination-controls">
                    <button class="btn" onclick="loadPrevAnnouncements()" id="btn-prev-announcements">
                        <i class="fa-solid fa-chevron-left"></i> 上一页
                    </button>
                    <span id="announcements-page-info"></span>
                    <button class="btn" onclick="loadMoreAnnouncements()" id="btn-next-announcements">
                        下一页 <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </section>

            <!-- CARDS VIEW -->
            <section id="cards" class="view">
                <header class="view-header">
                    <div class="header-left">
                        <h1>名片库</h1>
                        <div class="search-bar">
                            <input type="text" id="card-search-input" placeholder="筛选公司名称...">
                            <button class="btn small" onclick="loadCards(true)">搜索</button>
                        </div>
                    </div>
                    <div class="header-actions">
                        <span id="cards-count-info" class="count-info">加载中...</span>
                        <button class="btn primary" id="btn-export-cards">
                            <i class="fa-solid fa-download"></i> 导出名片
                        </button>
                    </div>
                </header>

                <div class="cards-grid" id="cards-container">
                    <!-- Populated by JS -->
                </div>

                <!-- Pagination -->
                <div class="pagination-controls">
                    <button class="btn" onclick="loadPrevCards()" id="btn-prev-cards">
                        <i class="fa-solid fa-chevron-left"></i> 上一页
                    </button>
                    <span id="cards-page-info"></span>
                    <button class="btn" onclick="loadMoreCards()" id="btn-next-cards">
                        下一页 <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </section>

        </main>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 id="modal-title">公告标题</h2>
            <div class="modal-meta">
                <span id="modal-date"></span> | <span id="modal-source"></span> | <a id="modal-url" href="#"
                    target="_blank">查看原文</a>
            </div>
            <div class="modal-body" id="modal-content">
                <!-- Content goes here -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <span class="close-export-modal">&times;</span>
            <h2>
                <i class="fa-solid fa-file-export" style="color: var(--primary); margin-right: 10px;"></i>导出配置
            </h2>

            <div class="modal-body">
                <div class="export-grid-layout">
                    <!-- Left Column: Filters -->
                    <div class="export-col-left">
                        <div class="form-group">
                            <label>品目</label>
                            <select id="export-pinmu">
                                <option value="">全部</option>
                                <option value="goods">货物类</option>
                                <option value="engineering">工程类</option>
                                <option value="services">服务类</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>来源类别</label>
                            <select id="export-category">
                                <option value="">全部</option>
                                <option value="central">中央</option>
                                <option value="local">地方</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>公告类型</label>
                            <select id="export-bid-type">
                                <option value="">全部</option>
                                <option value="1">公开招标</option>
                                <option value="7">中标公告</option>
                                <option value="2">竞争性谈判</option>
                                <option value="3">竞争性磋商</option>
                                <option value="4">询价公告</option>
                                <option value="5">单一来源</option>
                            </select>
                        </div>
                    </div>

                    <!-- Right Column: Time & Format -->
                    <div class="export-col-right">
                        <div class="time-row">
                            <div class="form-group">
                                <label>开始日期</label>
                                <input type="date" id="export-start-date">
                            </div>
                            <div class="form-group">
                                <label>结束日期</label>
                                <input type="date" id="export-end-date">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 10px;">
                            <label>文件名规则</label>
                            <div class="filter-grid" style="grid-template-columns: 1fr 1.5fr 1fr; gap: 8px;">
                                <div class="filter-item" style="margin:0;">
                                    <select id="filename-prefix" onchange="updateFilenamePreview()">
                                        <option value="">(无前缀)</option>
                                        <option value="date_">日期_</option>
                                        <option value="custom">自定义Prefix</option>
                                    </select>
                                    <input type="text" id="filename-prefix-custom" placeholder="前缀"
                                        style="display:none; margin-top:4px;" oninput="updateFilenamePreview()">
                                </div>
                                <div class="filter-item" style="margin:0;">
                                    <input type="text" id="filename-base" placeholder="文件名 (默认: announcements)"
                                        oninput="updateFilenamePreview()">
                                </div>
                                <div class="filter-item" style="margin:0;">
                                    <select id="filename-suffix" onchange="updateFilenamePreview()">
                                        <option value="">(无后缀)</option>
                                        <option value="_time">_时间</option>
                                        <option value="custom">自定义Suffix</option>
                                    </select>
                                    <input type="text" id="filename-suffix-custom" placeholder="后缀"
                                        style="display:none; margin-top:4px;" oninput="updateFilenamePreview()">
                                </div>
                            </div>
                            <div
                                style="margin-top: 6px; font-size: 0.8rem; color: var(--text-muted); text-align: right;">
                                预览: <span id="filename-preview" style="color: var(--primary);">announcements.xlsx</span>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 10px;">
                            <label>导出格式</label>
                            <div class="format-segment-control">
                                <div class="segment-option selected" onclick="selectExportFormat(this, 'all')">单文件</div>
                                <div class="segment-option" onclick="selectExportFormat(this, 'province')">按省份</div>
                                <div class="segment-option" onclick="selectExportFormat(this, 'day')">按日期</div>
                            </div>
                            <input type="hidden" id="selected-export-format" value="all">
                        </div>

                        <div class="checkbox-row" onclick="document.getElementById('export-include-details').click()">
                            <input type="checkbox" id="export-include-details" onclick="event.stopPropagation()">
                            <label for="export-include-details">包含详情内容</label>
                        </div>
                    </div>
                </div>

                <div class="export-footer">
                    <button class="export-btn-card primary" onclick="triggerExport()">
                        <i class="fa-solid fa-download"></i> 立即导出
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Detail Modal -->
    <div id="card-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-card-modal" style="float: right; font-size: 28px; cursor: pointer;">&times;</span>
            <h2 id="card-modal-title">公司名称</h2>
            <div class="modal-meta" style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <span id="card-modal-contact"></span>
            </div>
            <div class="modal-body">
                <h3 style="margin-top: 0;">关联公告 (来源)</h3>
                <div id="card-modal-mentions" class="mention-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>

</html>